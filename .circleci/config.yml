version: 2
jobs:
  build:
    environment:
      ORG: exonet
      APP: $ORG/wordpress
      TAG: latest
      IMAGE_ADDRESS: $AWS_USER_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      IMAGE_REPO: $IMAGE_ADDRESS/$APP

    docker:
      - image: docker:19.03
      # Setting an Environment Variables for app

    steps: # steps that comprise the `build` job
      - checkout # check out source code to working directory

      # - run: 
      #     name: "Setup custom environment variables"
      #     command: |
      #       echo 'export MY_ENV_VAR="FOO"' >> $BASH_ENV 
      #       echo 'export ORG="exonet"' >> $BASH_ENV 
      #       echo 'export APP="${ORG}/wordpress"' >> $BASH_ENV 
      #       echo 'export TAG="${ORG}/wordpress"' >> $BASH_ENV 
      #       echo 'export IMAGE_ADDRESS="$AWS_USER_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"' >> $BASH_ENV 
      #       echo 'export IMAGE_REPO="$IMAGE_ADDRESS/$APP"' >> $BASH_ENV 


      - setup_remote_docker:  
          version: 18.06.0-ce
          # docker_layer_caching: true 
          
      # Run a step to setup an environment variable.
      - run: 
          name: "Setup custom environment variables"
          command: |
            echo 'exporting docker-image'
            echo ${AWS_USER_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
            # docker login -u AWS --password-stdin $AWS_USER_SERVICE_KEY ${AWS_USER_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
            # docker build -t $APP:$TAG $CIRCLE_WORKING_DIRECTORY/docker/Dockerfile
            # docker tag ${APP}:${TAG} ${IMAGE_ADDRESS}/${ORG}:${TAG}
            # docker push ${IMAGE_REPO}:${TAG}

  build_ec2:
    docker:
      - image: ansible/ansible:ubuntu1604
      # - image: ${IMAGE_REPO}:${TAG}
      #   aws_auth:
      #     aws_access_key_id: $AWS_ACCESS_KEY_ID 
      #     aws_secret_access_key: $AWS_SECRET_ACCESS_KEY
    steps:
      - run:
          name: Install Ansible
          command: |
            apt update -y 
            apt install -y language-pack-ja-base language-pack-ja 
            apt install -y software-properties-common 
            apt-add-repository -y ppa:ansible/ansible 
            apt update -y 
            apt install -y curl python-dev git 
            curl "https://bootstrap.pypa.io/get-pip.py" -o "/tmp/get-pip.py" 
            python /tmp/get-pip.py 
            pip install --upgrade pip && pip install --upgrade setuptools 
            pip install ansible 

      - checkout
      - run:
          name: Validate Terraform Formatting
          command: |
            cd $CIRCLE_WORKING_DIRECTORY/roles/infra/files 
            "[ -z \"$(terraform fmt -write=false)\" ] || { terraform fmt -write=false -diff; exit 1}"
          
      - run:
          name: Execute Ansible Playbook
          command: |
            cd $CIRCLE_WORKING_DIRECTORY
            ansible-playbook site.yaml --tags "create" -vvv

            